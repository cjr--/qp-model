define(module,function(e,t){var n=t("qp-utility");n.make(e,{ns:"qp-model/model",$state:null,$members:null,init:function(e){var t=n.delete_key(e,this.schema.name);this.set_data(t,e),this.$state={created:e.create||!1,modified:!1,deleted:!1},this.$members=[],e&&e.display&&this.initialise({create:e.create}),e&&e.members&&this.set_members(e.members),e&&e.display&&this.refresh()},initialise:function(e){},refresh:function(){},set_members:function(e){n.each_own(e,function(e,t){this["set_"+t](e)}.bind(this))},add_member:function(e){-1===this.$members.indexOf(e)&&this.$members.push(e)},set_member:function(e,t,i,a){i=i||"id";var s=this[a=a||e+"_"+i];n.is(t,"array")&&(t=n.find(t,function(e){return e[i]===s})),n.is(t,"object")&&(this[e]=t,this[a]=t[i]),this.add_member(e)},set_list_member:function(e,t,i,a){this[e]=n.map(this[a],function(e){return n.find(t,function(t){return t[i]===e})}),this.add_member(e)},set_user:function(e){this.set_member("user",e)},set_data:function(e,t){n.each(this.schema.columns,function(t){var i=t.name;if(t.primary||t.primary_key){var a="_"+i;this[i]=e[i]||e[a]||n.id(),this[a]=e[i]||0}else t.datetime?this[i]=n.date(e[i])||t.default():this[i]=e[i]||t.default()}.bind(this))},get_data:function(e){var t=e&&e.target||{};return n.each(this.schema.columns,function(e){var i=e.name;if(e.primary||e.primary_key){var a="_"+i;t[i]=this[i]===this[a]?this[i]:0,t[a]=this[i]||0}else e.datetime?t[i]=n.date(this[i],"iso"):t[i]=this[i]}.bind(this)),t},clone:function(){var e={display:!0};e[this.schema.name]=this.get_data();var t=this.self.create(e);n.each(this.members,function(e){var i=this[e];i&&(n.is_array(i)?t["set_"+e](n.map(i,function(e){return e.clone?e.clone():null})):i.clone&&t["set_"+e](i.clone()))}.bind(this))}})}),define(module,function(e,t){var n=t("qp-utility"),i={2:6,4:11,8:20};function a(){return""}function s(){return 0}function r(){return!1}function u(){return new Date}function m(){return(new Date).setUTCHours(12,0,0,0)}function l(){return""}n.module(e,{ns:"qp-model/schema",extend:function(e,a){var s=t(a.extend);n.each_own(a.indexes,function(e,t){e.name=t,s.indexes[t]=e}),(s.api||a.api)&&(s.api=n.merge(s.api,a.api)),n.each_own(a.columns,function(e,t){var i=s.columns[t];i?n.merge(i,e):(e.name=t,i=s.columns[t]=e,e.managed?s.fields.managed.push(t):s.fields.all.push(t))}),n.each(a.meta.columns,function(e,t){var n=s.columns[e.name];n.index=t,0!==e.width?n.width=e.width:n.boolean?n.width=6:n.array?n.width=30:n.primary||n.primary_key||n.foreign?n.width=6:n.datetime?n.width=24:n.int?n.width=i[n.size]:n.numeric?n.width=n.size+n.scale+1:n.text?n.width=n.size||30:n.data&&(n.width=30),n.width=Math.max(n.name.length,n.width)}),e(s)},build:function(e,t){t.fields={managed:[],all:[]},t.columns=t.columns||{},t.indexes=t.indexes||{},t.schema_name=t.schema||!1;var i=t.schema_name?t.schema_name+".":"";t.table={name:t.table,fullname:i+t.table,id_sequence_name:i+t.table+"_id_seq"},n.each_own(t.indexes,function(e,t){e.name=t}),n.each_own(t.columns,function(e,n){e.name=n,e.managed?t.fields.managed.push(n):t.fields.all.push(n)}),t.create=this.create.bind(this,t.columns),t.get_schema=this.get_model_definition.bind(this,t),t.set_schema=this.set_schema.bind(this,t),e(t)},get_model_definition:function(e){var t={name:e.name},i=t.columns=[];return n.each_own(e.columns,function(e){e.internal||i.push(e)}),t},set_schema:function(e,t){!1===e.schema_name&&(e.schema_name=t);var i=e.schema_name?e.schema_name+".":"";return e.table.fullname=i+e.table.name,e.table.id_sequence_name=e.table.fullname+"_id_seq",n.each_own(e.columns,function(t,n){t.table_fullname=i+(t.table||e.table.name),t.fullname=t.table_fullname+"."+n}),e},create:function(e,t,i,a){return a=n.options(a,{internal:!1}),n.is(t,"array")?n.map(t,function(t){return this.create_item(e,t,null,a)}.bind(this)):n.is(t,"object","undefined")?this.create_item(e,t,i,a):null},create_item:function(e,t,i,a){return t=t||{},i=i||{},n.each_own(e,function(e,n){!a.internal&&e.internal||(i[n]=t[n]||e.default())}),i},index:function(e,t){return n.is(e,"object")?t=e||{}:n.is(e,"string")&&((t=t||{}).column=e),n.options(t,{column:null,expression:null,method:"btree",unique:!1,asc:!0,desc:!1})},field:function(e,t,i,d){var o;return n.is(t,"object","undefined")?(d=t,t=i=0):n.is(i,"object","undefined")&&(d=i,i=0),d=d||{},o="text"===e&&0===t?{type:"text",text:!0,size:0,default:d.default||a}:"text"===e?{type:"varchar",text:!0,size:t,default:d.default||a}:"smallint"===e||"int2"===e?{type:"smallint",int:!0,size:2,default:d.default||s}:"int"===e||"int4"===e||"integer"===e?{type:"integer",int:!0,size:4,default:d.default||s}:"bigint"===e||"int8"===e?{type:"bigint",int:!0,size:8,default:d.default||s}:"numeric"===e||"decimal"===e||"number"===e?{type:"numeric",numeric:!0,size:t,scale:i,default:d.default||s}:"currency"===e?{type:"numeric",numeric:!0,size:12,scale:4,default:d.default||s}:"bool"===e||"boolean"===e?{type:"boolean",boolean:!0,default:d.default||r}:"dt"===e||"datetime"===e?{type:"timestamp with time zone",datetime:!0,default:d.default||u}:"date"===e?{type:"timestamp with time zone",date:!0,default:d.default||m}:"bytea"===e?{type:"bytea",data:!0,default:d.default||l}:"smallserial"===e?{type:"smallserial",int:!0,size:2,default:n.noop}:"serial"===e?{type:"serial",int:!0,size:4,default:n.noop}:"bigserial"===e?{type:"bigserial",int:!0,size:8,default:n.noop}:{type:"",default:n.noop},n.options(o,d)},primary:function(e){return this.field("integer",n.options({primary:!0,managed:!0},e))},primary_key:function(e){return this.field("integer",n.options({primary_key:!0,sequence:!0,managed:!1},e))},foreign:function(e,t){return this.field("integer",n.options({foreign:!0,table:e},t))},foreign_ids:function(e,t){return this.field("integer",n.options({foreign:!0,table:e,array:!0},t))},unique:function(e){return this.field("integer",n.options({unique:!0,managed:!1},e))},created:function(e){return this.field("datetime",n.options({managed:!0},e))},modified:function(e){return this.field("datetime",n.options({managed:!0},e))}})});