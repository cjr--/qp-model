define(module,function(e,t){var n=t("qp-utility");n.make(e,{ns:"qp-model/model",init:function(e){var t=this.schema,i=n.delete_key(e,t.name);this.set_data(i,e),e&&e.display&&this.refresh()},refresh:function(){},set_user:function(e){n.is(e,"array")&&(e=n.find(e,{id:this.user_id})),n.is(e,"user")&&(this.user=e,this.user_id=e.id)},set_data:function(e,t){n.each(this.schema.columns,function(t){var i=t.name;if(t.primary||t.primary_key){var a="_"+i;this[i]=e[i]||e[a]||n.id(),this[a]=e[i]||0}else this[i]=e[i]||t.default()})},get_data:function(e){var t=e.target||{};return n.each(this.schema.columns,function(e){var n=e.name;if(e.primary||e.primary_key){var i="_"+n;t[n]=this[n]===this[i]?this[n]:0,t[i]=this[n]||0}else t[n]=this[n]}),t}})}),define(module,function(e,t){var n=t("qp-utility"),i={2:6,4:11,8:20};function a(){return""}function s(){return 0}function u(){return!1}function l(){return new Date}function r(){return(new Date).setUTCHours(12,0,0,0)}function d(){return""}n.module(e,{ns:"qp-model/schema",extend:function(e,a){var s=t(a.extend);n.each_own(a.indexes,function(e,t){e.name=t,s.indexes[t]=e}),n.each_own(a.columns,function(e,t){e.name=t,s.columns[t]=e,e.managed?s.fields.managed.push(t):s.fields.all.push(t)}),n.each(a.meta.columns,function(e,t){var n=s.columns[e.name];n.index=t,0!==e.width?n.width=e.width:n.boolean?n.width=6:n.array?n.width=30:n.primary||n.primary_key||n.foreign?n.width=6:n.datetime?n.width=24:n.int?n.width=i[n.size]:n.numeric?n.width=n.size+n.scale+1:n.text?n.width=n.size||30:n.data&&(n.width=30),n.width=Math.max(n.name.length,n.width)}),e(s)},build:function(e,t){t.fields={managed:[],all:[]},t.columns=t.columns||{},t.indexes=t.indexes||{},t.schema_name=t.schema||!1;var i=t.schema_name?t.schema_name+".":"";t.table={name:t.table,fullname:i+t.table,id_sequence_name:i+t.table+"_id_seq"},n.each_own(t.columns,function(e,n){e.name=n,e.managed?t.fields.managed.push(n):t.fields.all.push(n)}),n.each_own(t.indexes,function(e,t){e.name=t}),t.create=this.create.bind(this,t.columns),t.get_schema=this.get_model_definition.bind(this,t),t.set_schema=this.set_schema.bind(this,t),e(t)},get_model_definition:function(e){var t={name:e.name},i=t.columns=[];return n.each_own(e.columns,function(e){e.internal||i.push(e)}),t},set_schema:function(e,t){!1===e.schema_name&&(e.schema_name=t);var i=e.schema_name?e.schema_name+".":"";return e.table.fullname=i+e.table.name,e.table.id_sequence_name=e.table.fullname+"_id_seq",n.each_own(e.columns,function(t,n){t.table_fullname=i+(t.table||e.table.name),t.fullname=t.table_fullname+"."+n}),e},create:function(e,t,i,a){return a=n.options(a,{internal:!1}),n.is(t,"array")?n.map(t,function(t){return this.create_item(e,t,null,a)}.bind(this)):n.is(t,"object","undefined")?this.create_item(e,t,i,a):null},create_item:function(e,t,i,a){return t=t||{},i=i||{},n.each_own(e,function(e,n){!a.internal&&e.internal||(i[n]=t[n]||e.default())}),i},index:function(e,t){return n.is(e,"object")?t=e||{}:n.is(e,"string")&&((t=t||{}).column=e),n.options(t,{column:null,expression:null,method:"btree",unique:!1,asc:!0,desc:!1})},field:function(e,t,i,o){var m;return n.is(t,"object","undefined")?(o=t,t=i=0):n.is(i,"object","undefined")&&(o=i,i=0),o=o||{},m="text"===e&&0===t?{type:"text",text:!0,size:0,default:o.default||a}:"text"===e?{type:"varchar",text:!0,size:t,default:o.default||a}:"smallint"===e||"int2"===e?{type:"smallint",int:!0,size:2,default:o.default||s}:"int"===e||"int4"===e||"integer"===e?{type:"integer",int:!0,size:4,default:o.default||s}:"bigint"===e||"int8"===e?{type:"bigint",int:!0,size:8,default:o.default||s}:"numeric"===e||"decimal"===e||"number"===e?{type:"numeric",numeric:!0,size:t,scale:i,default:o.default||s}:"currency"===e?{type:"numeric",numeric:!0,size:12,scale:4,default:o.default||s}:"bool"===e||"boolean"===e?{type:"boolean",boolean:!0,default:o.default||u}:"dt"===e||"datetime"===e?{type:"timestamp with time zone",datetime:!0,default:o.default||l}:"date"===e?{type:"timestamp with time zone",date:!0,default:o.default||r}:"bytea"===e?{type:"bytea",data:!0,default:o.default||d}:"smallserial"===e?{type:"smallserial",int:!0,size:2,default:n.noop}:"serial"===e?{type:"serial",int:!0,size:4,default:n.noop}:"bigserial"===e?{type:"bigserial",int:!0,size:8,default:n.noop}:{type:"",default:n.noop},n.options(m,o)},primary:function(e){return this.field("integer",n.options({primary:!0,managed:!0},e))},primary_key:function(e){return this.field("integer",n.options({primary_key:!0,sequence:!0,managed:!1},e))},foreign:function(e,t){return this.field("integer",n.options({foreign:!0,table:e},t))},foreign_ids:function(e,t){return this.field("integer",n.options({foreign:!0,table:e,array:!0},t))},unique:function(e){return this.field("integer",n.options({unique:!0,managed:!1},e))},created:function(e){return this.field("datetime",n.options({managed:!0},e))},modified:function(e){return this.field("datetime",n.options({managed:!0},e))}})});