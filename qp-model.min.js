define(module,function(e,t){var s=t("qp-utility");s.make(e,{ns:"qp-model/model",$state:null,$members:null,init:function(e){var t=s.delete_key(e,this.schema.name);s.defined(t)&&null!==t&&(this.set_data(t,e),this.$state={created:e.create||!1,modified:!1,deleted:!1},this.$members=[],e&&e.display&&this.initialise({create:e.create}),e&&e.members&&this.set_members(e.members),e&&e.display&&this.refresh())},initialise:function(e){},refresh:function(){},set_members:function(e){s.each_own(e,function(e,t){this["set_"+t](e)}.bind(this))},add_member:function(e){-1===this.$members.indexOf(e)&&this.$members.push(e)},set_member:function(e,t,n,i){n=n||"id";var a=this[i=i||e+"_"+n];s.is(t,"array")&&(t=s.find(t,function(e){return e[n]===a})),s.is(t,"object")&&(this[e]=t,this[i]=t[n]),this.add_member(e)},set_list_member:function(e,n,i,t){this[e]=s.map(this[t],function(t){return s.find(n,function(e){return e[i]===t})}),this.add_member(e)},set_user:function(e){this.set_member("user",e)},set_data:function(i,e){s.each(this.schema.columns,function(e){var t=e.name;if(e.primary||e.primary_key){var n="_"+t;this[t]=i[t]||i[n]||s.id(),this[n]=i[t]||0}else e.datetime?this[t]=s.date(i[t])||e.default():this[t]=i[t]||e.default()}.bind(this))},get_data:function(e){var i=e&&e.target||{};return s.each(this.schema.columns,function(e){var t=e.name;if(e.primary||e.primary_key){var n="_"+t;i[t]=this[t]===this[n]?this[t]:0,i[n]=this[t]||0}else e.datetime?i[t]=s.date(this[t],"iso"):i[t]=this[t]}.bind(this)),i},clone:function(){var e={display:!0};e[this.schema.name]=this.get_data();var n=this.self.create(e);return s.each(this.$members,function(e){var t=this[e];t&&(s.is_array(t)?n["set_"+e](s.map(t,function(e){return e.clone?e.clone():null})):t.clone?n["set_"+e](t.clone()):n["set_"+e](s.clone(t)),n.add_member(e))}.bind(this)),n}})}),define(module,function(e,n){var r=n("qp-utility"),a={2:6,4:11,8:20},s={string:function(){return""},number:function(){return 0},boolean:function(){return!1},datetime:function(){return new Date},date:function(){return(new Date).setUTCHours(12,0,0,0)},min_datetime:function(){return new Date(-621355968e5)},max_datetime:function(){return new Date(2534022144e5)},bytea:function(){return""}};r.module(e,{ns:"qp-model/schema",extend:function(e,t){var i=n(t.extend);i.fields.system=[],r.each_own(t.triggers,function(e,t){i.triggers[t]=e}),r.each_own(t.indexes,function(e,t){e.name=t,i.indexes[t]=e}),(i.api||t.api)&&(i.api=r.merge(i.api,t.api)),r.each_own(t.columns,function(e,t){var n=i.columns[t];n?r.merge(n,e):(e.name=t,n=i.columns[t]=e,e.managed?i.fields.managed.push(t):(i.fields.all.push(t),i.fields.system.push(t)))}),r.each(t.meta.columns,function(e,t){var n=i.columns[e.name];n.index=t,0!==e.width?n.width=e.width:n.boolean?n.width=6:n.array?n.width=30:n.primary||n.primary_key||n.foreign?n.width=6:n.datetime?n.width=24:n.int?n.width=a[n.size]:n.numeric?n.width=n.size+n.scale+1:n.text?n.width=n.size||30:n.data&&(n.width=30),n.width=Math.max(n.name.length,n.width)}),e(i)},build:function(e,n){n.fields={managed:[],all:[],public:[]},n.columns=n.columns||{},n.triggers=n.triggers||{},n.indexes=n.indexes||{},n.schema_name=n.schema||!1;var t=n.schema_name?n.schema_name+".":"";n.table={name:n.table,fullname:t+n.table,id_sequence_name:t+n.table+"_id_seq"},r.each_own(n.indexes,function(e,t){e.name=t}),r.each_own(n.columns,function(e,t){e.name=t,e.managed?n.fields.managed.push(t):(n.fields.all.push(t),n.fields.public.push(t))}),n.create=this.create.bind(this,n.columns),n.get_schema=this.get_model_definition.bind(this,n),n.set_schema=this.set_schema.bind(this,n),e(n)},get_model_definition:function(e){var t={name:e.name},n=t.columns=[];return r.each_own(e.columns,function(e){e.internal||n.push(e)}),t},set_schema:function(n,e){!1===n.schema_name&&(n.schema_name=e);var i=n.schema_name?n.schema_name+".":"";return n.table.fullname=i+n.table.name,n.table.id_sequence_name=n.table.fullname+"_id_seq",r.each_own(n.columns,function(e,t){e.table_fullname=i+(e.table||n.table.name),e.fullname=e.table_fullname+"."+t}),n},create:function(t,e,n,i){return i=r.options(i,{internal:!1}),r.is(e,"array")?r.map(e,function(e){return this.create_item(t,e,null,i)}.bind(this)):r.is(e,"object","undefined")?this.create_item(t,e,n,i):null},create_item:function(e,i,a,s){return i=i||{},a=a||{},r.each_own(e,function(e,t){if(s.internal||!e.internal){var n=i[t];r.undefined(n)?a[t]=e.default():a[t]=n,e.datetime&&(a[t]===-1/0?a[t]=r.min_date():a[t]===1/0&&(a[t]=r.max_date()))}}),a},index:function(e,t){return r.is(e,"object")?t=e||{}:r.is(e,"string")&&((t=t||{}).column=e),r.options(t,{column:null,expression:null,method:"btree",unique:!1,asc:!0,desc:!1})},field:function(e,t,n,i){var a;return r.is(t,"object","undefined")?(i=t,t=n=0):r.is(n,"object","undefined")&&(i=n,n=0),i=i||{},r.is(i.default,"string")&&(i.default=s[i.default]),a="text"===e&&0===t?{type:"text",text:!0,size:0,default:i.default||s.string}:"text"===e?{type:"varchar",text:!0,size:t,default:i.default||s.string}:"smallint"===e||"int2"===e?{type:"smallint",int:!0,size:2,default:i.default||s.number}:"int"===e||"int4"===e||"integer"===e?{type:"integer",int:!0,size:4,default:i.default||s.number}:"bigint"===e||"int8"===e?{type:"bigint",int:!0,size:8,default:i.default||s.number}:"numeric"===e||"decimal"===e||"number"===e?{type:"numeric",numeric:!0,size:t,scale:n,default:i.default||s.number}:"currency"===e?{type:"numeric",numeric:!0,size:12,scale:4,default:i.default||s.number}:"bool"===e||"boolean"===e?{type:"boolean",boolean:!0,default:i.default||s.boolean}:"dt"===e||"datetime"===e?{type:"timestamp with time zone",datetime:!0,default:i.default||s.datetime}:"date"===e?{type:"timestamp with time zone",date:!0,default:i.default||s.date}:"bytea"===e?{type:"bytea",data:!0,default:i.default||s.bytea}:"jsonb"===e||"json"===e?{type:e,json:!0,default:i.default||s.string}:"smallserial"===e?{type:"smallserial",int:!0,size:2,default:r.noop}:"serial"===e?{type:"serial",int:!0,size:4,default:r.noop}:"bigserial"===e?{type:"bigserial",int:!0,size:8,default:r.noop}:{type:"",default:r.noop},r.options(a,i)},primary:function(e){return this.field("integer",r.options({primary:!0,managed:!0},e))},primary_key:function(e){return this.field("integer",r.options({primary_key:!0,sequence:!0,managed:!1},e))},foreign:function(e,t){return this.field("integer",r.options({foreign:!0,table:e},t))},foreign_ids:function(e,t){return this.field("integer",r.options({foreign:!0,table:e,array:!0,default:function(){return[]}},t))},unique:function(e){return this.field("integer",r.options({unique:!0,managed:!1},e))},created:function(e){return this.field("datetime",r.options({managed:!0},e))},modified:function(e){return this.field("datetime",r.options({managed:!0},e))}})});