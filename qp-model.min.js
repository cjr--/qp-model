define(module,function(e,t){var i=t("qp-utility");i.make(e,{ns:"qp-model/model",init:function(e){var t=i.delete_key(e,this.schema.name);this.set_data(t,e),e&&e.display&&(this.initialise({create:e.create}),this.refresh())},initialise:function(e){},refresh:function(){},set_user:function(e){i.is(e,"array")&&(e=i.find(e,{id:this.user_id})),i.is(e,"user")&&(this.user=e,this.user_id=e.id)},set_data:function(e,t){i.each(this.schema.columns,function(t){var n=t.name;if(t.primary||t.primary_key){var a="_"+n;this[n]=e[n]||e[a]||i.id(),this[a]=e[n]||0}else t.datetime?this[n]=i.date(e[n])||t.default():this[n]=e[n]||t.default()}.bind(this))},get_data:function(e){var t=e.target||{};return i.each(this.schema.columns,function(e){var n=e.name;if(e.primary||e.primary_key){var a="_"+n;t[n]=this[n]===this[a]?this[n]:0,t[a]=this[n]||0}else e.datetime?t[n]=i.date(this[n],"iso"):t[n]=this[n]}.bind(this)),t}})}),define(module,function(e,t){var i=t("qp-utility"),n={2:6,4:11,8:20};function a(){return""}function s(){return 0}function u(){return!1}function l(){return new Date}function r(){return(new Date).setUTCHours(12,0,0,0)}function d(){return""}i.module(e,{ns:"qp-model/schema",extend:function(e,a){var s=t(a.extend);i.each_own(a.indexes,function(e,t){e.name=t,s.indexes[t]=e}),(s.api||a.api)&&(s.api=i.merge(s.api,a.api)),i.each_own(a.columns,function(e,t){var n=s.columns[t];n?i.merge(n,e):(e.name=t,n=s.columns[t]=e,e.managed?s.fields.managed.push(t):s.fields.all.push(t))}),i.each(a.meta.columns,function(e,t){var i=s.columns[e.name];i.index=t,0!==e.width?i.width=e.width:i.boolean?i.width=6:i.array?i.width=30:i.primary||i.primary_key||i.foreign?i.width=6:i.datetime?i.width=24:i.int?i.width=n[i.size]:i.numeric?i.width=i.size+i.scale+1:i.text?i.width=i.size||30:i.data&&(i.width=30),i.width=Math.max(i.name.length,i.width)}),e(s)},build:function(e,t){t.fields={managed:[],all:[]},t.columns=t.columns||{},t.indexes=t.indexes||{},t.schema_name=t.schema||!1;var n=t.schema_name?t.schema_name+".":"";t.table={name:t.table,fullname:n+t.table,id_sequence_name:n+t.table+"_id_seq"},i.each_own(t.indexes,function(e,t){e.name=t}),i.each_own(t.columns,function(e,i){e.name=i,e.managed?t.fields.managed.push(i):t.fields.all.push(i)}),t.create=this.create.bind(this,t.columns),t.get_schema=this.get_model_definition.bind(this,t),t.set_schema=this.set_schema.bind(this,t),e(t)},get_model_definition:function(e){var t={name:e.name},n=t.columns=[];return i.each_own(e.columns,function(e){e.internal||n.push(e)}),t},set_schema:function(e,t){!1===e.schema_name&&(e.schema_name=t);var n=e.schema_name?e.schema_name+".":"";return e.table.fullname=n+e.table.name,e.table.id_sequence_name=e.table.fullname+"_id_seq",i.each_own(e.columns,function(t,i){t.table_fullname=n+(t.table||e.table.name),t.fullname=t.table_fullname+"."+i}),e},create:function(e,t,n,a){return a=i.options(a,{internal:!1}),i.is(t,"array")?i.map(t,function(t){return this.create_item(e,t,null,a)}.bind(this)):i.is(t,"object","undefined")?this.create_item(e,t,n,a):null},create_item:function(e,t,n,a){return t=t||{},n=n||{},i.each_own(e,function(e,i){!a.internal&&e.internal||(n[i]=t[i]||e.default())}),n},index:function(e,t){return i.is(e,"object")?t=e||{}:i.is(e,"string")&&((t=t||{}).column=e),i.options(t,{column:null,expression:null,method:"btree",unique:!1,asc:!0,desc:!1})},field:function(e,t,n,o){var m;return i.is(t,"object","undefined")?(o=t,t=n=0):i.is(n,"object","undefined")&&(o=n,n=0),o=o||{},m="text"===e&&0===t?{type:"text",text:!0,size:0,default:o.default||a}:"text"===e?{type:"varchar",text:!0,size:t,default:o.default||a}:"smallint"===e||"int2"===e?{type:"smallint",int:!0,size:2,default:o.default||s}:"int"===e||"int4"===e||"integer"===e?{type:"integer",int:!0,size:4,default:o.default||s}:"bigint"===e||"int8"===e?{type:"bigint",int:!0,size:8,default:o.default||s}:"numeric"===e||"decimal"===e||"number"===e?{type:"numeric",numeric:!0,size:t,scale:n,default:o.default||s}:"currency"===e?{type:"numeric",numeric:!0,size:12,scale:4,default:o.default||s}:"bool"===e||"boolean"===e?{type:"boolean",boolean:!0,default:o.default||u}:"dt"===e||"datetime"===e?{type:"timestamp with time zone",datetime:!0,default:o.default||l}:"date"===e?{type:"timestamp with time zone",date:!0,default:o.default||r}:"bytea"===e?{type:"bytea",data:!0,default:o.default||d}:"smallserial"===e?{type:"smallserial",int:!0,size:2,default:i.noop}:"serial"===e?{type:"serial",int:!0,size:4,default:i.noop}:"bigserial"===e?{type:"bigserial",int:!0,size:8,default:i.noop}:{type:"",default:i.noop},i.options(m,o)},primary:function(e){return this.field("integer",i.options({primary:!0,managed:!0},e))},primary_key:function(e){return this.field("integer",i.options({primary_key:!0,sequence:!0,managed:!1},e))},foreign:function(e,t){return this.field("integer",i.options({foreign:!0,table:e},t))},foreign_ids:function(e,t){return this.field("integer",i.options({foreign:!0,table:e,array:!0},t))},unique:function(e){return this.field("integer",i.options({unique:!0,managed:!1},e))},created:function(e){return this.field("datetime",i.options({managed:!0},e))},modified:function(e){return this.field("datetime",i.options({managed:!0},e))}})});